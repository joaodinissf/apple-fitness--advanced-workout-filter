<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Fitness+ - Advanced Workout Filter</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .workout-card {
            background: #e8efff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 6px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .workout-card.needs-update {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .workout-header {
            margin-bottom: 20px;
        }

        .workout-title-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .workout-title-link:hover {
            text-decoration: none;
        }

        .workout-title-link:hover .workout-title {
            color: #667eea;
            text-decoration: underline;
        }

        .workout-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
            transition: color 0.2s ease;
        }

        .workout-url {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            word-break: break-all;
            font-size: 14px;
            text-decoration: none;
            transition: color 0.2s;
        }

        .workout-url:hover {
            color: #5a6fd8;
            text-decoration: underline;
        }

        .workout-metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .metadata-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metadata-label {
            font-weight: 600;
            color: #495057;
            min-width: 80px;
        }

        .metadata-value {
            color: #333;
            flex: 1;
        }

        .workout-meta {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .update-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #856404;
        }

        .songs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .song-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .song-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .song-artist {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .song-link {
            font-size: 12px;
        }

        .song-link a {
            color: #667eea;
            text-decoration: none;
        }

        .song-link a:hover {
            text-decoration: underline;
        }

        .no-results {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }

        .stats {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .highlight {
            background: yellow;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .filters {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
        }

        .filters h3 {
            margin: 0 0 15px 0;
            color: #495057;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.clear {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        .filter-btn.clear:hover {
            background: #e9ecef;
        }

        .update-btn {
            margin-left: 15px;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .update-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .update-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .update-status {
            margin-left: 10px;
            font-size: 12px;
            color: #28a745;
            font-weight: 600;
        }

        .clickable-cached {
            cursor: pointer;
            transition: color 0.2s;
        }

        .clickable-cached:hover {
            color: #667eea;
        }

        /* Toast notification styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 350px;
        }

        .toast {
            background: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.info {
            background: #17a2b8;
        }

        /* Make tooltips appear immediately */
        [title] {
            position: relative;
        }

        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 4px;
        }

        [title]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéµ Apple Fitness+ - Advanced Workout Filter</h1>

        <div
            style="background: #f8f9fa; border-radius: 6px; padding: 15px; margin-bottom: 20px; font-size: 12px; color: #666; border-left: 3px solid #6c757d;">
            <strong>Legal Notice:</strong> This project is not affiliated with, endorsed by, or sponsored by Apple Inc.
            or any other company.
            Apple, Apple Fitness+, Apple Music, and all related trademarks are the property of Apple Inc.
            All other trademarks, service marks, and trade names referenced are the property of their respective owners.
            This is an independent, educational project for personal use only.
        </div>

        <div class="header-actions">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by song title or artist name..."
                    oninput="applyFilters()">
            </div>
            <a href="/add" class="btn btn-primary">‚ûï Add Workouts</a>
        </div>

        <div class="filters">
            <h3>üîç Filters</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="categoryFilter">üèÉ Category</label>
                    <select id="categoryFilter" onchange="applyFilters()">
                        <option value="">All Categories</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="trainerFilter">üë§ Trainer</label>
                    <select id="trainerFilter" onchange="applyFilters()">
                        <option value="">All Trainers</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="genreFilter">üéµ Genre</label>
                    <select id="genreFilter" onchange="applyFilters()">
                        <option value="">All Genres</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="durationFilter">‚è±Ô∏è Duration</label>
                    <select id="durationFilter" onchange="applyFilters()">
                        <option value="">All Durations</option>
                    </select>
                </div>
            </div>

            <!-- Visual separator -->
            <div style="border-top: 2px solid #dee2e6; margin: 20px 0; padding-top: 20px;">
                <h3>üìä Sort</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="sortBy">Order by</label>
                        <select id="sortBy" onchange="applySorting()">
                            <option value="cached_at_desc">üìÖ Date (Newest first)</option>
                            <option value="cached_at_asc">üìÖ Date (Oldest first)</option>
                            <option value="duration_asc">‚è±Ô∏è Duration (Shortest first)</option>
                            <option value="duration_desc">‚è±Ô∏è Duration (Longest first)</option>
                            <option value="title_asc">üèãÔ∏è Title (A-Z)</option>
                            <option value="title_desc">üèãÔ∏è Title (Z-A)</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <div class="filter-actions" style="margin-top: 28px;">
                            <button class="filter-btn clear" onclick="clearFilters()">üóëÔ∏è Clear All</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats" id="stats">
            Total: {{ cache_data|length }} workouts
        </div>

        <div id="workouts">
            {% if cache_data %}
            {% for workout in cache_data %}
            <div class="workout-card {{ 'needs-update' if workout.needs_update }}" data-workout="{{ loop.index0 }}"
                data-trainer="{{ workout.trainer or '' }}" data-category="{{ workout.workout_category or '' }}"
                data-genre="{{ workout.genre or '' }}" data-duration-bucket="{{ workout.duration_bucket or '' }}"
                data-cached-at="{{ workout.cached_at }}" data-title="{{ workout.title or '' }}"
                data-duration-raw="{{ workout.duration or '' }}">
                {% if workout.needs_update %}
                <div class="update-notice">
                    ‚ö†Ô∏è This entry needs updating - metadata may be incomplete
                </div>
                {% endif %}

                <div class="workout-header">
                    <a href="{{ workout.url }}" target="_blank" rel="noopener noreferrer" class="workout-title-link">
                        <div class="workout-title">{{ workout.title }}</div>
                    </a>

                    <div class="workout-meta">
                        {% if workout.needs_update %}
                        <span class="cached-info">Indexed {{ workout.cached_at }} ‚Ä¢ {{ workout.song_count }}
                            songs</span>
                        <button class="update-btn"
                            onclick="updateSingleWorkout('{{ workout.url | replace("'", "\\'") }}')"
                            title="Force update this workout">
                            üîÑ Update
                        </button>
                        {% else %}
                        <span class="cached-info clickable-cached"
                            onclick="updateSingleWorkout('{{ workout.url | replace("'", "\\'") }}')"
                            title="Click to trigger a refresh of this workout's metadata">
                            Indexed {{ workout.cached_at }} ‚Ä¢ {{ workout.song_count }} songs
                        </span>
                        {% endif %}
                    </div>


                    {% if workout.workout_category or workout.trainer or workout.genre or workout.duration or
                    workout.episode or workout.date %}
                    <div class="workout-metadata">
                        {% if workout.workout_category %}
                        <div class="metadata-item">
                            <span class="metadata-label">üèÉ Category:</span>
                            <span class="metadata-value">{{ workout.workout_category }}</span>
                        </div>
                        {% endif %}

                        {% if workout.trainer %}
                        <div class="metadata-item">
                            <span class="metadata-label">üë§ Trainer:</span>
                            <span class="metadata-value">{{ workout.trainer }}</span>
                        </div>
                        {% endif %}

                        {% if workout.genre %}
                        <div class="metadata-item">
                            <span class="metadata-label">üéµ Genre:</span>
                            <span class="metadata-value">{{ workout.genre }}</span>
                        </div>
                        {% endif %}

                        {% if workout.duration %}
                        <div class="metadata-item">
                            <span class="metadata-label">‚è±Ô∏è Duration:</span>
                            <span class="metadata-value">{{ workout.duration }}</span>
                        </div>
                        {% endif %}

                        {% if workout.episode %}
                        <div class="metadata-item">
                            <span class="metadata-label">üì∫ Episode:</span>
                            <span class="metadata-value">{{ workout.episode }}</span>
                        </div>
                        {% endif %}

                        {% if workout.date %}
                        <div class="metadata-item">
                            <span class="metadata-label">üìÖ Date:</span>
                            <span class="metadata-value">{{ workout.date }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="songs-grid">
                    {% for song in workout.songs %}
                    <div class="song-item" data-title="{{ song.title|lower }}" data-artist="{{ song.artist|lower }}">
                        <div class="song-title">{{ song.title }}</div>
                        <div class="song-artist">{{ song.artist }}</div>
                        {% if song.apple_music_url %}
                        <div class="song-link">
                            <a href="{{ song.apple_music_url }}" target="_blank">üéµ Open in Apple Music</a>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="no-results">
                No workouts in library yet. Use the scraper to add some workouts first!
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Load filter options on page load
        window.addEventListener('DOMContentLoaded', function () {
            loadFilterOptions();
            updateSearchPlaceholder();
        });

        function updateSearchPlaceholder() {
            const searchInput = document.getElementById('searchInput');
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const shortcut = isMac ? '‚åòK' : 'Ctrl+K';
            searchInput.placeholder = `Search by song title or artist name... (${shortcut})`;
        }

        // Apply sorting after page is fully loaded
        window.addEventListener('load', function () {
            applySorting();
        });

        // Add keyboard shortcut for search (Ctrl+K or Cmd+K)
        document.addEventListener('keydown', function (event) {
            // Check for Ctrl+K (Windows/Linux) or Cmd+K (Mac)
            if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                event.preventDefault(); // Prevent browser's default Ctrl+K behavior
                const searchInput = document.getElementById('searchInput');

                // Scroll to search bar with smooth animation
                searchInput.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                // Focus and select after a brief delay to ensure scrolling completes
                setTimeout(() => {
                    searchInput.focus();
                    searchInput.select(); // Select any existing text for easy replacement
                }, 100);
            }
        });

        function loadFilterOptions() {
            fetch('/filter-options')
                .then(response => response.json())
                .then(data => {
                    // Populate trainer dropdown
                    const trainerSelect = document.getElementById('trainerFilter');
                    data.trainers.forEach(trainer => {
                        const option = document.createElement('option');
                        option.value = trainer;
                        option.textContent = trainer;
                        trainerSelect.appendChild(option);
                    });

                    // Populate category dropdown
                    const categorySelect = document.getElementById('categoryFilter');
                    data.workout_categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });

                    // Populate genre dropdown
                    const genreSelect = document.getElementById('genreFilter');
                    data.genres.forEach(genre => {
                        const option = document.createElement('option');
                        option.value = genre;
                        option.textContent = genre;
                        genreSelect.appendChild(option);
                    });

                    // Populate duration dropdown with actual durations from cache
                    const durationSelect = document.getElementById('durationFilter');
                    data.durations.forEach(duration => {
                        const option = document.createElement('option');
                        option.value = duration;
                        option.textContent = duration + (duration === 45 ? '+ minutes' : ' minutes');
                        durationSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading filter options:', error));
        }

        function applyFilters() {
            const trainerFilter = document.getElementById('trainerFilter').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
            const genreFilter = document.getElementById('genreFilter').value.toLowerCase();
            const durationFilter = document.getElementById('durationFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            const workoutCards = document.querySelectorAll('.workout-card');
            let visibleWorkouts = 0;
            let visibleSongs = 0;

            workoutCards.forEach(card => {
                const cardTrainer = card.getAttribute('data-trainer').toLowerCase();
                const cardCategory = card.getAttribute('data-category').toLowerCase();
                const cardGenre = card.getAttribute('data-genre').toLowerCase();
                const cardDuration = card.getAttribute('data-duration-bucket');

                // Check filters
                const matchesTrainer = !trainerFilter || cardTrainer.includes(trainerFilter);
                const matchesCategory = !categoryFilter || cardCategory.includes(categoryFilter);
                const matchesGenre = !genreFilter || cardGenre.includes(genreFilter);
                const matchesDuration = !durationFilter || cardDuration === durationFilter;

                // Check search term (existing logic)
                let matchesSearch = true;
                let songCount = 0;

                if (searchTerm) {
                    const songs = card.querySelectorAll('.song-item');
                    let hasMatchingSongs = false;

                    songs.forEach(song => {
                        const title = song.getAttribute('data-title');
                        const artist = song.getAttribute('data-artist');

                        if (title.includes(searchTerm) || artist.includes(searchTerm)) {
                            song.style.display = 'block';
                            highlightText(song, searchTerm);
                            hasMatchingSongs = true;
                            songCount++;
                        } else {
                            song.style.display = 'none';
                            clearHighlights(song);
                        }
                    });

                    matchesSearch = hasMatchingSongs;
                    visibleSongs += songCount;
                } else {
                    // Show all songs when no search term
                    const songs = card.querySelectorAll('.song-item');
                    songs.forEach(song => {
                        song.style.display = 'block';
                        clearHighlights(song);
                    });
                    songCount = songs.length;
                    visibleSongs += songCount;
                }

                // Show/hide card based on all criteria
                if (matchesTrainer && matchesCategory && matchesGenre && matchesDuration && matchesSearch) {
                    card.style.display = 'block';
                    visibleWorkouts++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Update stats
            updateStats(visibleWorkouts, visibleSongs, searchTerm, trainerFilter, categoryFilter, genreFilter, durationFilter);
        }

        function clearFilters() {
            document.getElementById('trainerFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('genreFilter').value = '';
            document.getElementById('durationFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('sortBy').value = 'cached_at_desc';
            applyFilters();
            applySorting();
        }

        function applySorting() {
            const sortBy = document.getElementById('sortBy').value;
            const workoutsContainer = document.getElementById('workouts');
            const workoutCards = Array.from(document.querySelectorAll('.workout-card'));

            // Exit if no cards found (page not fully loaded yet)
            if (workoutCards.length === 0) {
                return;
            }

            // Sort the cards based on selected criteria
            workoutCards.sort((a, b) => {
                let valueA, valueB;

                switch (sortBy) {
                    case 'cached_at_desc':
                        valueA = new Date(a.getAttribute('data-cached-at'));
                        valueB = new Date(b.getAttribute('data-cached-at'));
                        return valueB - valueA; // Newest first

                    case 'cached_at_asc':
                        valueA = new Date(a.getAttribute('data-cached-at'));
                        valueB = new Date(b.getAttribute('data-cached-at'));
                        return valueA - valueB; // Oldest first

                    case 'duration_asc':
                        valueA = parseDuration(a.getAttribute('data-duration-raw'));
                        valueB = parseDuration(b.getAttribute('data-duration-raw'));
                        return valueA - valueB; // Shortest first

                    case 'duration_desc':
                        valueA = parseDuration(a.getAttribute('data-duration-raw'));
                        valueB = parseDuration(b.getAttribute('data-duration-raw'));
                        return valueB - valueA; // Longest first

                    case 'title_asc':
                        valueA = a.getAttribute('data-title').toLowerCase();
                        valueB = b.getAttribute('data-title').toLowerCase();
                        return valueA.localeCompare(valueB); // A-Z

                    case 'title_desc':
                        valueA = a.getAttribute('data-title').toLowerCase();
                        valueB = b.getAttribute('data-title').toLowerCase();
                        return valueB.localeCompare(valueA); // Z-A

                    default:
                        return 0;
                }
            });

            // Remove all cards from container
            workoutCards.forEach(card => card.remove());

            // Re-append cards in sorted order
            workoutCards.forEach(card => workoutsContainer.appendChild(card));
        }

        function parseDuration(durationStr) {
            // Parse duration string like "45min", "10min" to numbers
            if (!durationStr) return 0;
            const match = durationStr.match(/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }

        function updateStats(visibleWorkouts, visibleSongs, searchTerm, trainerFilter, categoryFilter, genreFilter, durationFilter) {
            const statsDiv = document.getElementById('stats');
            const hasFilters = searchTerm || trainerFilter || categoryFilter || genreFilter || durationFilter;

            if (hasFilters) {
                let filterText = [];
                if (searchTerm) filterText.push(`searching "${searchTerm}"`);
                if (trainerFilter) filterText.push(`trainer: ${trainerFilter}`);
                if (categoryFilter) filterText.push(`category: ${categoryFilter}`);
                if (genreFilter) filterText.push(`genre: ${genreFilter}`);
                if (durationFilter) filterText.push(`duration: ${durationFilter}min`);

                statsDiv.textContent = `Found: ${visibleSongs} songs in ${visibleWorkouts} workouts (${filterText.join(', ')})`;
            } else {
                statsDiv.textContent = `Total: {{ cache_data|length }} workouts`;
            }
        }


        function highlightText(songElement, searchTerm) {
            const titleElement = songElement.querySelector('.song-title');
            const artistElement = songElement.querySelector('.song-artist');

            highlightInElement(titleElement, searchTerm);
            highlightInElement(artistElement, searchTerm);
        }

        function highlightInElement(element, searchTerm) {
            const originalText = element.textContent;
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            const highlightedText = originalText.replace(regex, '<span class="highlight">$1</span>');
            element.innerHTML = highlightedText;
        }

        function clearHighlights(songElement) {
            const titleElement = songElement.querySelector('.song-title');
            const artistElement = songElement.querySelector('.song-artist');

            if (titleElement.innerHTML.includes('<span class="highlight">')) {
                titleElement.innerHTML = titleElement.textContent;
            }
            if (artistElement.innerHTML.includes('<span class="highlight">')) {
                artistElement.innerHTML = artistElement.textContent;
            }
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function updateSingleWorkout(url) {
            const button = event.target;
            const originalText = button.textContent;
            const isButtonElement = button.tagName === 'BUTTON';

            // Check if already processing first
            fetch('/status')
                .then(response => response.json())
                .then(status => {
                    if (status.is_processing) {
                        showToast('‚è≥ Another update is in progress. Please wait...', 'info');
                        return;
                    }

                    // Show loading toast
                    showToast('‚è≥ Starting update...', 'info');

                    // Disable button if it's a button element
                    if (isButtonElement) {
                        button.disabled = true;
                        button.textContent = '‚è≥ Updating...';
                    }

                    startUpdateProcess(url, button, originalText, isButtonElement);
                })
                .catch(error => {
                    showToast('‚ùå Error checking status: ' + error, 'error');
                });
        }

        function startUpdateProcess(url, button, originalText, isButtonElement) {
            fetch('/update-single', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast('‚ùå Error: ' + data.error, 'error');
                        if (isButtonElement) {
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                    } else {
                        // Poll for completion
                        pollSingleUpdateStatus(button, originalText, isButtonElement);
                    }
                })
                .catch(error => {
                    showToast('‚ùå Error: ' + error, 'error');
                    if (isButtonElement) {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                });
        }

        function pollSingleUpdateStatus(button, originalText, isButtonElement) {
            const pollInterval = setInterval(() => {
                fetch('/status')
                    .then(response => response.json())
                    .then(status => {
                        if (!status.is_processing) {
                            // Update completed
                            clearInterval(pollInterval);
                            if (isButtonElement) {
                                button.disabled = false;
                                button.textContent = originalText;
                            }

                            showToast('‚úÖ Updated successfully!', 'success');

                            // Reload page after short delay to show updated data
                            setTimeout(() => {
                                window.location.reload();
                            }, 200);
                        }
                    })
                    .catch(error => {
                        clearInterval(pollInterval);
                        if (isButtonElement) {
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                        showToast('‚ùå Update failed', 'error');
                    });
            }, 1000);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);

            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }
    </script>
</body>

</html>